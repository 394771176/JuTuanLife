/* mix-view-adaptor (min) v0.3.7, build at 2019-11-08 16:53. */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e["mix-view-adaptor"]=t()}(this,function(){"use strict";"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{writable:!0,enumerable:!1,configurable:!0,value:function(e){var t=arguments;if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var r=Object(e),n=1;n<arguments.length;n++){var i=t[n];if(null!=i)for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(r[o]=i[o])}return r}});var t,u='object[type="application/view"]',c='div[type="application/view"][original-type="object"]',s="mixviewcallback",d="query",O="data-object-id",l="data-observed",v=(t=Date.now()%999999,function(e){return void 0===e&&(e="mix_view"),e+"_"+t++});function f(){return"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:new Function("return this")()}function n(){var e=f();return e&&e.__mix_view_environment__}function r(){return{r:(99999999*Math.random()|0)%256,g:(99999999*Math.random()|0)%256,b:(99999999*Math.random()|0)%256,a:.01}}function p(e){return"rgba("+e.r+","+e.g+","+e.b+","+e.a+")"}var i,h=(i={},function(){for(var e=r(),t=p(e);i[t];)t=p(e=r());return i[t]=e});function o(n,i){var o;return void 0===i&&(i=0),"function"!=typeof setTimeout||"function"!=typeof clearTimeout?n:function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];var r=this;clearTimeout(o),o=setTimeout(function(){return n.apply(r,e)},i)}}function a(){return"object"==typeof process&&process&&process.env&&"test"===process.env.PURPOSE}function m(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function b(e){return Object.prototype.toString.call(e).slice(8,-1)}function g(e){return"Object"===b(e)}function y(e){return"Function"===b(e)}function _(e){return e&&1===e.nodeType}function w(){var e=n();return e&&"color"===e.matchType}function A(e){var t=n();return!(!g(t.availableTypes)||!m(t.availableTypes,e))}function E(e){return"type"===e||"viewType"===e}function N(e){return w()?_(e)&&/^object$/i.test(e.nodeName)&&"application/view"===String(e.getAttribute("type")).toLowerCase()&&"object"===String(e.getAttribute("original-type")).toLowerCase():_(e)&&/^object$/i.test(e.nodeName)&&"application/view"===String(e.getAttribute("type")).toLowerCase()}function j(e){return _(e)&&/^param$/i.test(e.nodeName)}function x(e){return!1!==e&&0!==e&&!e||"undefined"==e||"null"==e||"NaN"==e}function e(){var e=n();return e&&"string"==typeof e.platform&&"android"===e.platform.toLowerCase()}function C(){var e=f(),t=n();return e&&void 0!==e.AFAppX||t&&"yes"===String(t.isForAppX).toLowerCase()}function T(){return C()?"1":"0"}var L=["all","debug","log","warn","error","silent"],S="warn",P=function(e,t){var r="["+function(e){return e.charAt(0).toUpperCase()+e.slice(1)}(e)+"][mix_view] "+t;if("function"==typeof console[e]&&"debug"!==e)return console[e](r);console.log(r)};function M(e){if(a())return"function"==typeof __test_logger__&&(P=__test_logger__,!0);var t=n(),r=t&&t.logLevel||S;return L.indexOf(e)>=L.indexOf(r)}function q(e){M("debug")&&P("debug",e)}function k(e){M("warn")&&P("warn",e)}function F(e){M("error")&&P("error",e)}function D(){}D.prototype.postMessage=function(e){if(e&&e.length){var t=f();try{q("Post message: "+JSON.stringify(e)),t.webkit.messageHandlers.mixView.postMessage(e)}catch(e){F("Failed to postMessage: "+e.toString())}}},D.prototype.onmessage=function(t,r){void 0===r&&(r="mixviewevent"),f().addEventListener(r,function(e){q('Receive event "'+r+'": '+JSON.stringify(e.data)),e&&g(e.data)&&"function"==typeof t&&t(e.data)})};var I=function(e){function t(){e.call(this)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.postMessage=function(e){if(e&&e.length){var t=f();try{q("Post message (on Android): "+JSON.stringify(e)),t.mixView.postMessage(e)}catch(e){F("Failed to postMessage (on Android): "+e.toString())}}},t}(D),V="[[EVENT_MAP]]";function R(e,t){var r=e[V];return Array.isArray(r[t])||(r[t]=[]),r[t]}function $(){Object.defineProperty(this,V,{configurable:!1,enumerable:!1,writable:!1,value:{}})}$.prototype.on=function(e,t){return R(this,e).push({listener:t,once:!1,callCount:0}),this},$.prototype.once=function(e,t){return R(this,e).push({listener:t,once:!0,callCount:0}),this},$.prototype.off=function(e,t){var r=this[V];if(t){var n=r[e];if(Array.isArray(n)){var i=n.findIndex(function(e){return e.listener===t});-1!==i&&n.splice(i,1)}}else delete r[e];return this},$.prototype.emit=function(t){for(var r=[],e=arguments.length-1;0<e--;)r[e]=arguments[e+1];var n=this[V],i=n[t];return Array.isArray(i)&&(n[t]=i.filter(function(e){try{e.listener.apply(null,r),e.callCount+=1}catch(e){return F('Failed to emit "'+t+'" event.\n'+e.toString()),!0}return!e.once})),this};var J=e()?new I:new D,U=new $;function H(e,t,r){return t+"_"+r+"@"+e}function z(o,a){o[a]=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return q('Call the "'+a+'" method on '+o.tagName+"#"+o.id),new Promise(function(r,n){var i=v();U.once(H(o.id,a,i),function(e){if(q('Receive callback of "'+a+'" on '+o.tagName+"#"+o.id+" (id: "+i+")."),g(e))!function(e){if(!g(e)||!m(e,"success"))return!1;if("string"==typeof e.success)switch(e.success.toLowerCase()){case"true":case"1":return!0;case"false":case"0":return!1}return!!e.success}(e)?n(e.data):r(e.data);else{var t='Invalid message format of the "'+a+'" callback!';F(t),n(new Error(t))}}),J.postMessage([{id:o.id,action:"callMethod",name:a,args:e,callbackId:i}]),J.onmessage(function(e){var t=e.id,r=e.name,n=e.callbackId;U.emit(H(t,r,n),e)},s)})};try{Object.defineProperty(o[a],a,{value:a})}catch(e){}}function X(t,e){_(t)&&function(e){return"Array"===b(e)}(e)&&(q('Register native methods on "'+t.tagName+"#"+t.id+'" ('+e.join(", ")+")."),e.forEach(function(e){z(t,e)}))}var Q=["border-top-left-radius","border-top-right-radius","border-bottom-left-radius","border-bottom-right-radius","border-radius"],W=["style","class",l,O];function B(e){var t={};if(e.hasAttributes())for(var r=0;r<e.attributes.length;++r){var n=e.attributes[r];-1===W.indexOf(n.name)&&(t[n.name]=n.value)}return t}function G(e,t){void 0===t&&(t={}),q("Start parse the <"+e.tagName+' id="'+e.id+'"> element');var r="",n={};if(e.children)for(var i=0;i<e.children.length;++i){var o=e.children[i];if(j(o)){var a=o.getAttribute("name");E(a)?A(r=o.getAttribute("value"))||F('The "'+r+'" view type is not supported!'):n[a]=B(o),q('Set "'+O+'" of <'+o.tagName+' name="'+a+'"> to be "'+e.id+'".'),o.setAttribute(O,e.id)}}var s=[];for(var u in e){var c=/^on([a-z]+)$/.exec(u);c&&c[1]&&y(e[u])&&s.push(c[1])}var d={type:r,viewType:r,styles:function(e){var t=f();if(t&&"function"==typeof t.getComputedStyle){var r=t.getComputedStyle(e),n={};return Q.forEach(function(e){n[e]=r.getPropertyValue(e)}),n}return{}}(e),backgroundColor:t.backgroundColor};return Object.keys(n).length&&(d.params=n),s.length&&(d.events=s),d}function K(n,i){var o=n,a=[];o._events=Object.create(null);function e(e){var t,r=/^on([a-z]+)$/.exec(e);r&&r[1]&&(t=r[1],o._events[t]=n[e],Object.defineProperty(n,e,{enumerable:!0,configurable:!0,get:function(){return o._events[t]},set:function(e){y(i)&&i(t,e,o._events[t]),o._events[t]=e}}),y(n[e])&&a.push(t))}for(var t in n)e(t);return a}function Y(e,n,i){m(e,"addEventListener")||(e._addEventListener=e.addEventListener,Object.defineProperty(e,"addEventListener",{writable:!0,enumerable:!0,configurable:!0,value:function(e,t,r){y(n)&&n(e,this),this._addEventListener(e,t,r)}})),m(e,"removeEventListener")||(e._removeEventListener=e.removeEventListener,Object.defineProperty(e,"removeEventListener",{writable:!0,enumerable:!0,configurable:!0,value:function(e,t,r){y(i)&&i(e,this),this._removeEventListener(e,t,r)}}))}var Z=["title","style","class",l,O];function ee(t){return new MutationObserver(function(e){var w=[];e.forEach(function(e){var t,r,n,i=e.type,o=e.attributeName,a=e.oldValue,s=e.target;if(1===s.nodeType)switch(i){case"attributes":var u=s.getAttribute(o);if(!function(e,t){return!N(e)&&!j(e)||-1!==Z.indexOf(t)}(s,o)&&!function(e,t){return e==t||x(e)&&x(t)}(a,u))if(q('Captured "'+o+'" attribute change of <'+s.nodeName+'> (old: "'+a+'", new: "'+u+'").'),N(s)){var c={id:s.id,appx:T(),action:"setAttributes",args:[(t={},t[o]=u,t)]};w.push(c)}else if(j(s)){var d=s.getAttribute(O),l=s.getAttribute("name"),v=B(s);q('The "'+l+'" param of #'+d+" object is changed to "+JSON.stringify(v)+"."),w.push({id:d,action:"setParams",args:[(r={},r[l]=v,r)]})}break;case"childList":if(!N(s))break;var f=e.addedNodes,p=e.removedNodes;if(q("Captured params change of <"+s.nodeName+"> (added: "+f.length+", removed: "+p.length+")."),f.length)for(var h=0;h<f.length;++h)if(j(f[h])){var m=f[h],b=m.getAttribute("name");m.setAttribute(O,s.id),q("Captured newly inserted <"+m.nodeName+' name="'+b+'"> and set its "'+O+'" to be "'+s.id+'".'),w.push({id:s.id,action:"setParams",args:[(n={},n[b]=B(m),n)]})}if(p.length)for(var g=0;g<p.length;++g)if(j(p[g])){var y=p[g],_=y.getAttribute("name");q("Captured the <"+y.nodeName+' name="'+_+'"> has been deleted.'),w.push({id:y.getAttribute(O),action:"removeParams",args:[_]})}}}),t(w)})}function te(e,t){if(void 0===t&&(t="div"),!e.parentNode)return k("The <"+e.tagName+"> element is offline, can't replace its tagName."),e;if(e.tagName.toLowerCase()===t.toLowerCase())return e;for(var r=document.createElement(t),n=0,i=e.attributes.length;n<i;++n){var o=e.attributes.item(n).nodeName,a=e.attributes.item(n).nodeValue;r.setAttribute(o,a)}for(;e.firstChild;)r.appendChild(e.firstChild);return e.parentNode.replaceChild(r,e),r}function re(e){for(var t=[],r=0;r<e.length;++r){var n=e[r];if("function"==typeof n.matches&&(n.matches(u)||n.matches(c))&&-1===t.indexOf(n)&&t.push(n),"function"==typeof n.querySelectorAll){for(var i=n.querySelectorAll(u),o=0;o<i.length;++o)-1===t.indexOf(i[o])&&t.push(i[o]);for(var a=n.querySelectorAll(c),s=0;s<a.length;++s)-1===t.indexOf(a[s])&&t.push(a[s])}}return t}function ne(){return!C()}function ie(){this._label=v("manager"),this._views=Object.create(null),this._messages=Object.create(null),this._observers=Object.create(null),e()?this._bridge=new I:this._bridge=new D,this._setup()}function oe(){var t=new ie;q("Setup MixView Manager "+t.label()),function(t,r,e){void 0===e&&(e=!0);var n=f();try{Object.defineProperty(n,t,{value:r,configurable:!0,enumerable:!0,writable:!e})}catch(e){n[t]=r}}("__mix_view_manager__",t),document.addEventListener("DOMContentLoaded",function(){t.observeDocument(),t.queryAndObserve()}),setTimeout(function(){t.observeDocument(),t.queryAndObserve();var e=setInterval(function(){t.queryAndObserve()},3e3);setTimeout(function(){return clearInterval(e)},1e4)},0)}return ie.prototype._isObserved=function(e){return!(!e||e.getAttribute(l)!=this._label)},ie.prototype._setup=function(){var s=this;this.send=o(function(){return s._sendMessages()},30);function u(){q("Start query and observe mix views. (observing: "+Object.keys(s._views).join(", ")+")"),s.query(),s.observe(),s.send()}ne()?(q("Add 10ms debounce for queryAndObserve."),this.queryAndObserve=o(u,10)):(q("No debounce for queryAndObserve."),this.queryAndObserve=u),this._bridge.onmessage(function(e){var t=e.id,r=e.name,n=e.data;if(r!=d){if(s._views[t]){q('Dispatch "'+r+'" event on "#'+t+'".');var i=s._views[t].element,o=new CustomEvent(r,{detail:n});o.data=n,i.dispatchEvent(o)}}else{q('Query element of "'+t+'" ('+d+")"),u();var a=s._views[t];a&&a.options?(q('Found listening element of "'+t+'" (type: '+a.options.viewType+")"),s.schedule([{id:t,appx:T(),action:"queryElement",args:[a.options]}]),s._sendMessages()):k("Can't find element of \""+t+'".')}});function e(e,t){N(t)&&(s.schedule([{id:t.id,appx:T(),action:"addEvent",args:[e]}]),s.send())}function t(e,t){N(t)&&(s.schedule([{id:t.id,appx:T(),action:"removeEvent",args:[e]}]),s.send())}Y(HTMLObjectElement.prototype,e,t),w()&&Y(HTMLDivElement.prototype,e,t)},ie.prototype._parseInlineEvent=function(e){var n=this,i=e.id,t=K(e,function(e,t,r){y(t)&&!y(r)?n.schedule([{id:i,appx:T(),action:"addEvent",args:[e]}]):!y(t)&&y(r)&&n.schedule([{id:i,appx:T(),action:"removeEvent",args:[e]}]),n.send()});t.length&&(this.schedule([{id:i,appx:T(),action:"addEvent",args:t}]),this.send())},ie.prototype._registerMethods=function(e,t){var r=n();r&&g(r.availableTypes)&&X(e,r.availableTypes[t])},ie.prototype._sendMessages=function(){var e=[];for(var t in this._messages){var r=this._messages[t];for(var n in r){var i={id:t,appx:T(),action:n};m(r,n)&&r[n]&&(i.args=r[n]),e.push(i),delete r[n]}delete this._messages[t]}e.length&&this._bridge.postMessage(e)},ie.prototype.label=function(){return this._label},ie.prototype.shouldDowngrade=function(e){return!n()||!(!_(e)||A(function(e){if(N(e)&&e.children.length)for(var t=0;t<e.children.length;++t){var r=e.children[t];if(j(r)&&E(r.getAttribute("name")))return r.getAttribute("value")}return j(e)&&E(e.getAttribute("name"))?e.getAttribute("value"):""}(e)))&&(e.dispatchEvent(new Event("error")),!0)},ie.prototype.query=function(){var t=this,e=function(e){void 0===e&&(e=function(){return!0});for(var t={},r=re([document]),n=0;n<r.length;++n){var i=r[n];if(1===i.nodeType&&e(i)){q("Found the <"+i.nodeName+"> element (#"+i.id+") and start to preprocess it.");var o=i.tagName.toLowerCase();w()&&"div"!==o&&(k("The <"+o+"> element is not supported in current environment, it will be replaced by a <div> element."),(i=te(i,"div")).setAttribute("original-type",o));var a=v();i.id?t[i.id]&&(k('The id "'+i.id+'" of <'+i.nodeName+'> has already been used, it will be replaced by "'+a+'".'),i.id=a,i.setAttribute("id",a)):(i.id=a,i.setAttribute("id",a));var s=h();i.style["-webkit-transform"]="translate3d(0,0,0)",i.style["background-color"]=p(s),t[i.id]={options:G(i,{backgroundColor:s}),element:i}}}return t}(function(e){return e&&!t._views[e.id]});for(var r in e)this._views[r]||(this._views[r]=e[r]);return this},ie.prototype.observe=function(){var t=this;for(var e in this._views){var r=this._views[e],n=r.options,i=r.element;if(!this._observers[e]){q("Start to observe the <"+i.tagName+"> element (#"+i.id+")."),this._parseInlineEvent(i),this._registerMethods(i,n.viewType||n.type);var o=ee(function(e){t.schedule(e),t.send()});o.observe(i,{attributes:!0,attributeOldValue:!0,childList:!0,subtree:!0}),this._observers[e]=o,i.setAttribute(l,this._label),this.schedule([{id:e,appx:T(),action:"createElement",args:[n]}])}}return this},ie.prototype.schedule=function(e){var u=this;return e.forEach(function(e){var t=e.id,r=e.action,n=e.args;m(u._messages,t)||(u._messages[t]=Object.create(null));var i=u._messages[t];if(m(i,r)&&n?(-1!==["setParams","setAttributes","setStyles"].indexOf(r)&&n.forEach(function(e,t){i[r][t]?Object.assign(i[r][t],e):i[r][t]=e}),-1!==["removeParams","removeAttributes","removeStyles","addEvent","removeEvent"].indexOf(r)&&n.forEach(function(e){-1===i[r].indexOf(e)&&i[r].push(e)})):i[r]=n,m(i,"createElement")&&m(i,"removeElement")&&(delete i.createElement,delete i.removeElement),m(i,"createElement")&&i.createElement[0]){var o=i.createElement[0];if(m(i,"addEvent")&&(o.events=o.events?i.addEvent:o.events.concat(i.addEvent),delete i.addEvent),m(i,"removeEvent")&&o.events){for(var a=0;a<i.removeEvent.length;++a){var s=o.events.indexOf(i.removeEvent[a]);-1!==s&&o.events.splice(s,1)}delete i.removeEvent}m(i,"setParams")&&(i.setParams.forEach(function(e){o.params=Object.assign({},o.params,e)}),delete i.setParams),m(i,"removeParams")&&o.params&&(i.removeParams.forEach(function(e){delete o.params[e]}),delete i.removeParams)}}),this},ie.prototype.observeDocument=function(e){var s=this;if(void 0===e&&(e=document.body),e){if(this._isObserved(e))this.cleanUp(e);else{var t=function(e){e.forEach(function(e){var t=e.type,r=e.target,n=e.addedNodes,i=e.removedNodes;if("childList"===t&&1===r.nodeType){q("Captured element tree change of <"+r.nodeName+"> (added: "+n.length+", removed: "+i.length+").");var o=re(i);if(o.length)for(var a=0;a<o.length;++a)s.stopObserve(o[a]);(n.length||o.length)&&s.queryAndObserve()}})},r=ne()?new MutationObserver(o(t,5)):new MutationObserver(t);q("Start observe the root element <"+e.tagName+">."),r.observe(e,{childList:!0,subtree:!0}),e.setAttribute(l,this._label)}return this}k('No available "document.body", will try again!')},ie.prototype.stopObserve=function(e){if(N(e)&&this._isObserved(e)){var t=e.id;q("Stop observe <"+e.tagName+"> (#"+t+")."),delete this._views[t],delete this._messages[t],this._observers[t]&&(this._observers[t].disconnect(),delete this._observers[t]),e.removeAttribute(l),this.schedule([{id:t,appx:T(),action:"removeElement"}])}return this},ie.prototype.cleanUp=function(e){if(void 0===e&&(e=document.body),q("Will clean up observed elements."),e&&!this._isObserved(e)){e.removeAttribute(l);for(var t=re([e]),r=0;r<t.length;++r)if(1===t[r].nodeType){var n=t[r],i=n.id;q("Remove observe flags on <"+n.tagName+"> (#"+i+")."),delete this._views[i],delete this._messages[i],this._observers[i]&&(this._observers[i].disconnect(),delete this._observers[i]),n.removeAttribute("original-type"),n.removeAttribute(l);for(var o=n.querySelectorAll("param"),a=0;a<o.length;++a)if(1===o[a].nodeType){var s=o[a];q("Remove observe flags on <"+s.tagName+"> (#"+s.id+")."),s.removeAttribute(O),s.removeAttribute(l)}}}},a()||oe(),oe});
